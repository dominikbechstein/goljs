<!DOCTYPE html>
<html>
<head>

    <meta charset="utf-8">
    <title>GoL</title>

</head>
<body>


<script>

!function () {
    "use strict";

    var rules = {
        // Conways Original-Game of Life
        "23/3": {
            random: 9,
            getState: function (sum, oldState) {
                let state = oldState;

                if (oldState === 1) {
                    state = sum === 2 || sum === 3 ? 1 : 0;
                } else if (oldState === 0 && sum === 3) {
                    state = 1;
                }

                return state;
            }
        },
        // eine Welt, in der ein sich ausbreitendes, labyrinthartiges Muster entsteht
        "12345/3": {
            random: 9.9,
            getState: function (sum, oldState) {
                let state = oldState;

                if (oldState === 1) {
                    state = "12345".indexOf(sum) !== -1 ? 1 : 0;
                } else if (oldState === 0 && sum === 3) {
                    state = 1;
                }

                return state;
            }
        },
        // ein Kopiersystem, wobei sich aus einfachen kleinen Strukturen komplexe Muster entwickeln k√∂nnen
        "1357/1357": {
            random: 9.9999,
            getState: function (sum, oldState) {
                let state = oldState;

                if (oldState === 1) {
                    state = sum % 2 === 1 ? 1 : 0;
                } else if (oldState === 0 && sum % 2 === 1) {
                    state = 1;
                }

                return state;
            }
        },

        "01234678/0123478": {
            random: 2,
            getState: function (sum, oldState) {
                let state = oldState;

                if (oldState === 1) {
                    state = "01234678".indexOf(sum) !== -1 ? 1 : 0;
                } else if (oldState === 0 && "0123478".indexOf(sum) !== -1) {
                    state = 1;
                }

                return state;
            }
        },

        "3/245": {
            size: 2,
            random: 0.4,
            getState: function (sum, oldState) {
                let state = oldState;

                if (oldState === 1) {
                    state = sum === 3 ? 1 : 0;
                } else if (oldState === 0 && "245".indexOf(sum) !== -1) {
                    state = 1;
                }

                return state;
            }
        },

        "23/346": {
            size: 2,
            random: 0.7,
            getState: function (sum, oldState) {
                let state = oldState;

                if (oldState === 1) {
                    state = sum === 2 || sum === 3 ? 1 : 0;
                } else if (oldState === 0 && "346".indexOf(sum) !== -1) {
                    state = 1;
                }

                return state;
            }
        }
    };

    var   rule    = rules["23/346"];
    const size    = rule.size;
    const height  = Math.floor(700  / size);
    const width   = Math.floor(1400 / size);
    const cDead   = "#eeeeee";
    var   cAlive  = "#555555";


    const bh = height - 1;
    const bw = width  - 1;

    const dots = new Array(width);

    let cnt  = 0;

    const options = Object.keys(rules).map(function (key) {
        return '<option value="' + key + '">' + key + '</option>';
    });

    document.body.innerHTML =
        'rule <select id="rules">' + options + '</select> <button id="reset">reset</button>' +
        '<div id="info">-</div>' +
        '<canvas id="world" width="' + width * size + '" height="' + height * size + '" style="border: 1px solid #999"></canvas>'
    ;

    const select = document.getElementById("rules");
    const reset  = document.getElementById("reset");
    const info   = document.getElementById("info");
    const world  = document.getElementById("world").getContext("2d");

    select.onchange = function () {
        rule = rules[select.options[select.selectedIndex].value];
        initWorld();
    };

    reset.onclick = initWorld;

    // draw dot
    function draw(world, x, y, state) {
        world.fillStyle = state ? cAlive : cDead;
        world.fillRect(x * size, y * size, size, size);

        return state;
    }

    // init world with random dots
    function initWorld() {
        for (let x = 0; x < width; ++x) {
            const row = new Uint8Array(height);

            for (let y = 0; y < height; ++y) {
                row[y] = draw(world, x, y, Math.random() * 10 > rule.random ? 1 : 0);
            }

            dots[x] = row;
        }
    }

    initWorld();

    let fps  = "", step = cnt;

    // calc fps
    setInterval(function () {
        const diff =  cnt - step;

        step = cnt;
        fps  = diff;
    }, 1000);

    setInterval(function () {
        if (cAlive < cDead) {
            cAlive = "#" + (parseInt(cAlive.substr(1), 16) + 255).toString(16);
        }
    }, 5);


    // main loop
    setInterval(function () {
        const next = new Array(width);
        var population = 0;
        let x, y;

        for (x = 0; x < width; ++x) {
            const row = new Uint8Array(height);

            for (y = 0; y < height; ++y) {
                const lt = dots[x == 0 ? bw : x - 1]  [y == 0 ? bh : y - 1];
                const mt = dots[x == 0 ? bw : x - 1]  [y];
                const rt = dots[x == 0 ? bw : x - 1]  [y == bh ? 0 : y + 1];

                const lm = dots[x]                    [y == 0 ? bh : y - 1];
                const rm = dots[x]                    [y == bh ? 0 : y + 1];

                const lb = dots[x == bw ? 0 : x + 1]  [y == 0 ? bh : y - 1];
                const mb = dots[x == bw ? 0 : x + 1]  [y];
                const rb = dots[x == bw ? 0 : x + 1]  [y == bh ? 0 : y + 1];

                // calc surroundings
                const sum =
                    lt + mt + rt +
                    lm + rm +
                    lb + mb + rb
                ;

                const oldState = dots[x][y];
                const state    = rule.getState(sum, oldState);

                // only draw if state has changed
                if (oldState != state) {
                    draw(world, x, y, state);
                }

                population += state;

                row[y] = state;
            }

            next[x] = row;
        }

        // copy array
        for (x = 0; x < width; ++x) {
            dots[x] = next[x].subarray();
        }

        info.innerHTML = "dots: " + width * height + " - generation: " + ++cnt + " - population: " + population + " - fps: " + fps;
    });
}();
</script>
</body>

</html>